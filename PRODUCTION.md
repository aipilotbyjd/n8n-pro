# n8n Pro - Production Deployment Guide

This guide will help you deploy n8n Pro in a production environment with Docker and Docker Compose.

## üöÄ Quick Start

### 1. Run Production Setup

The quickest way to get started is to run the production setup script:

```bash
./scripts/setup-production.sh
```

This script will:
- ‚úÖ Check prerequisites (Docker, Docker Compose, OpenSSL)
- üîê Generate secure passwords and encryption keys
- üìù Create production environment configuration (`.env.production`)
- üê≥ Create production Docker Compose configuration
- üìä Set up monitoring and backup scripts
- üìÅ Create necessary directories (logs, storage, backups)

### 2. Start Production Services

```bash
# Start all services in production mode
docker-compose -f docker-compose.production.yml up -d

# Check service status
docker-compose -f docker-compose.production.yml ps

# View logs
docker-compose -f docker-compose.production.yml logs -f
```

### 3. Verify Services

```bash
# Check health endpoints
curl http://localhost:8080/health    # API Service
curl http://localhost:8081/health    # Webhook Service  
curl http://localhost:8082/health    # Worker 1
curl http://localhost:8083/health    # Worker 2

# Or use the monitoring script
./scripts/monitor.sh
```

## üèóÔ∏è Architecture Overview

The production setup includes:

### Services
- **API Service** (`:8080`) - REST API and GraphQL endpoint
- **Webhook Service** (`:8081`) - Handles incoming webhooks
- **Worker Services** (`:8082`, `:8083`) - Two worker instances for scalability
- **Scheduler Service** - Handles CRON jobs and scheduled tasks

### Infrastructure
- **PostgreSQL 15** (`:5432`) - Primary database with production optimizations
- **Redis 7** (`:6379`) - Caching and session storage with persistence
- **Apache Kafka 3.6** (`:9092`) - Message queue for distributed processing

### Volumes & Data Persistence
- `postgres_data` - Database data persistence
- `redis_data` - Redis data persistence with AOF
- `kafka_data` - Kafka logs and metadata
- `./storage` - Application file storage
- `./logs` - Application logs with rotation
- `./backups` - Database backups

## üîí Security Features

### Production Security Settings
- ‚úÖ **Secure passwords** auto-generated with OpenSSL
- ‚úÖ **JWT tokens** with configurable expiration
- ‚úÖ **Encryption at rest** with AES-256 encryption
- ‚úÖ **Network isolation** with Docker bridge networks
- ‚úÖ **Security headers** (HSTS, CSP, X-Frame-Options)
- ‚úÖ **Rate limiting** on API and webhook endpoints
- ‚úÖ **CSRF protection** enabled
- ‚úÖ **Non-root containers** for security

### Port Binding
In production mode, database ports are bound only to `127.0.0.1` (localhost) to prevent external access:
- PostgreSQL: `127.0.0.1:5432:5432`
- Redis: `127.0.0.1:6379:6379`
- Kafka: `127.0.0.1:9092:9092`

## üìä Monitoring & Observability

### Health Checks
All services include comprehensive health checks:
- **API**: HTTP health endpoint with service status
- **Worker**: Health check on dedicated port
- **Webhook**: HTTP health endpoint
- **Database**: PostgreSQL connection checks
- **Redis**: Ping response checks
- **Kafka**: Topic listing capability

### Metrics & Monitoring
- **Prometheus metrics** available at `:9090/metrics`
- **Structured JSON logging** with log rotation
- **Resource limits** and reservations for all services
- **Service restart policies** (always restart)

### Monitoring Script
Use the included monitoring script to check system health:

```bash
./scripts/monitor.sh
```

This will show:
- üîç Service health status
- üìä Docker container status
- üíæ Disk usage
- üß† Memory usage
- ‚ö° System load

## üíæ Backup & Recovery

### Automated Backups
The production setup includes an automated backup script:

```bash
# Run manual backup
./scripts/backup.sh

# Schedule daily backups (add to crontab)
0 2 * * * /path/to/n8n-pro/scripts/backup.sh
```

### Backup Features
- ‚úÖ **PostgreSQL dumps** with compression
- ‚úÖ **Automatic cleanup** (keeps 30 days of backups)
- ‚úÖ **Timestamped backups** for easy identification
- ‚úÖ **Error handling** and logging

### Recovery
To restore from a backup:

```bash
# Stop services
docker-compose -f docker-compose.production.yml down

# Restore database
gunzip -c backups/n8n_pro_backup_YYYYMMDD_HHMMSS.sql.gz | \
docker-compose -f docker-compose.production.yml exec -T postgres \
psql -U n8n_pro -d n8n_clone

# Restart services
docker-compose -f docker-compose.production.yml up -d
```

## üîß Configuration

### Environment Variables
The production setup uses `.env.production` for configuration:

#### Key Security Settings
```bash
JWT_SECRET=<auto-generated-64-char-secret>
ENCRYPTION_KEY=<auto-generated-32-char-key>
DB_PASSWORD=<auto-generated-secure-password>
REDIS_PASSWORD=<auto-generated-secure-password>
```

#### Performance Tuning
```bash
# Database
DB_MAX_OPEN_CONNECTIONS=50
DB_MAX_IDLE_CONNECTIONS=10
DB_CONNECTION_LIFETIME=30m

# Redis
REDIS_POOL_SIZE=20
REDIS_MAX_IDLE_CONNECTIONS=20
REDIS_CONN_MAX_LIFETIME=1h

# Workers
WORKER_CONCURRENCY=20
WORKER_JOB_TIMEOUT=30m
SANDBOX_MAX_CONCURRENT_JOBS=10

# System Limits
LIMITS_MAX_WORKFLOWS_PER_TEAM=500
LIMITS_MAX_CONCURRENT_EXECUTIONS=50
LIMITS_MAX_EXECUTION_TIME=30m
```

## üìà Scaling

### Horizontal Scaling
The production setup includes multiple worker instances by default:

- **worker-1** (`:8082`) - First worker instance
- **worker-2** (`:8083`) - Second worker instance

To add more workers:

1. Copy the `worker-2` service definition in `docker-compose.production.yml`
2. Update the container name and port mapping
3. Restart the stack

### Vertical Scaling
Resource limits are configured for each service:

```yaml
deploy:
  resources:
    limits:
      memory: 2G      # Maximum memory
      cpus: '2.0'     # Maximum CPU cores
    reservations:
      memory: 1G      # Guaranteed memory
      cpus: '1.0'     # Guaranteed CPU cores
```

## üö® Troubleshooting

### Common Issues

#### Services not starting
```bash
# Check service logs
docker-compose -f docker-compose.production.yml logs service-name

# Check system resources
docker stats

# Verify health checks
./scripts/monitor.sh
```

#### Database connection issues
```bash
# Test database connection
docker-compose -f docker-compose.production.yml exec postgres \
psql -U n8n_pro -d n8n_clone -c "SELECT 1;"

# Check database logs
docker-compose -f docker-compose.production.yml logs postgres
```

#### High memory usage
```bash
# Check container memory usage
docker stats

# Adjust resource limits in docker-compose.production.yml
# Restart services
docker-compose -f docker-compose.production.yml restart
```

### Log Analysis
Application logs are structured JSON and can be analyzed with:

```bash
# View recent API logs
docker-compose -f docker-compose.production.yml logs --tail=100 api

# Filter logs by level
docker-compose -f docker-compose.production.yml logs api | grep '"level":"error"'

# Follow live logs
docker-compose -f docker-compose.production.yml logs -f --tail=50
```

## üìã Maintenance

### Regular Maintenance Tasks

#### Daily
- ‚úÖ Check service health (`./scripts/monitor.sh`)
- ‚úÖ Review error logs
- ‚úÖ Verify backup completion

#### Weekly  
- ‚úÖ Review resource usage trends
- ‚úÖ Check disk space
- ‚úÖ Update security patches
- ‚úÖ Test backup restoration

#### Monthly
- ‚úÖ Review and rotate credentials
- ‚úÖ Update Docker images
- ‚úÖ Performance optimization review
- ‚úÖ Cleanup old logs and backups

### Updates
To update to a new version:

```bash
# Pull latest code
git pull origin main

# Rebuild containers
docker-compose -f docker-compose.production.yml build --no-cache

# Restart with new images
docker-compose -f docker-compose.production.yml up -d
```

## üîê Production Checklist

Before going live, ensure:

- [ ] **SSL/TLS certificates** are configured for HTTPS
- [ ] **CORS origins** are set to your domain in `.env.production`
- [ ] **Firewall rules** are configured to allow only necessary ports
- [ ] **Monitoring** and alerting systems are set up
- [ ] **Backup automation** is scheduled and tested
- [ ] **Log aggregation** system is configured
- [ ] **Resource monitoring** is in place
- [ ] **Security scanning** has been performed
- [ ] **Load testing** has been completed
- [ ] **Disaster recovery** procedures are documented

## üìû Support

For issues or questions:

1. **Check logs** first using the monitoring script
2. **Review documentation** in this repository
3. **Search existing issues** in the repository
4. **Create a new issue** with detailed information including:
   - Service logs
   - System information
   - Steps to reproduce
   - Expected vs actual behavior

---

**n8n Pro** - Enterprise workflow automation made simple and secure! üöÄ